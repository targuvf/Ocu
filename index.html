<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Quest Byttn</title>
  <style>
    body { margin: 0; background: black; overflow: hidden; }
    #info { position: absolute; top: 10px; width: 100%; text-align: center; color: white; font-family: sans-serif; z-index: 1; }
  </style>
</head>
<body>
  <div id="info">Initializing...</div>
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js';
    import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/webxr/VRButton.js';

    let camera, scene, renderer;
    let controllers = [];

    init();
    animate();

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);

      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
      camera.position.set(0, 1.6, 3);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);
      document.body.appendChild(VRButton.createButton(renderer));

      const light = new THREE.HemisphereLight(0xffffff, 0x444444);
      light.position.set(0, 1, 0);
      scene.add(light);

      const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(4, 4),
        new THREE.MeshStandardMaterial({ color: 0x111111 })
      );
      floor.rotation.x = -Math.PI / 2;
      scene.add(floor);

      // Setup 2 controllers
      const circleGeo = new THREE.CircleGeometry(0.05, 32);
      const circleMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });

      for (let i = 0; i < 2; i++) {
        const controller = renderer.xr.getController(i);
        const circle = new THREE.Mesh(circleGeo, circleMat);
        circle.rotation.x = -Math.PI / 2;
        controller.add(circle);
        controllers.push(controller);
        scene.add(controller);
      }

      window.addEventListener('resize', onWindowResize);
      document.getElementById('info').innerText = 'Click the VR button to enter VR';
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      renderer.setAnimationLoop(render);
    }

    function render(timestamp, frame) {
      // Poll controller pose to ensure circles follow
      if (renderer.xr.isPresenting && frame) {
        const session = renderer.xr.getSession();
        session.inputSources.forEach((src, idx) => {
          if (src.targetRaySpace && controllers[idx]) {
            const refSpace = renderer.xr.getReferenceSpace();
            const pose = frame.getPose(src.targetRaySpace, refSpace);
            if (pose) {
              controllers[idx].matrix.fromArray(pose.transform.matrix);
              controllers[idx].matrix.decompose(controllers[idx].position, controllers[idx].quaternion, controllers[idx].scale);
            }
          }
        });
      }
      renderer.render(scene, camera);
    }
  </script>
</body>
